<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gantt — Tarefas</title>
  <link rel="stylesheet" href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css" />
  <script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    #gantt_here {
      width: 100%;
      height: 100vh;
    }

    /* ── Header: label "Tarefas" à direita + botão verde circular ── */
    .header-tarefas {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 6px;
      width: 100%;
      padding-right: 4px;
      box-sizing: border-box;
    }
    .header-add-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: none;
      background: #4caf50;
      color: #fff;
      font-size: 0.85rem;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
      flex-shrink: 0;
    }
    .header-add-btn:hover {
      background: #43a047;
    }

    /* ── Botões nas linhas de tarefa principal ── */
    .task-cell {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn-expand {
      font-size: 0.7rem;
      cursor: pointer;
      border: none;
      background: transparent;
      padding: 2px 4px;
      color: #555;
      line-height: 1;
    }
    .btn-add-sub {
      font-size: 0.75rem;
      cursor: pointer;
      border: none;
      background: transparent;
      padding: 2px 4px;
      color: #4caf50;
      font-weight: bold;
      line-height: 1;
    }
    .btn-expand:hover { color: #222; }
    .btn-add-sub:hover { opacity: 0.7; }

    /* ── Esconder coluna "add" padrão do DHTMLX ── */
    .gantt_add { display: none !important; }

    /* ── Modal ── */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active { display: flex; }

    .modal-box {
      background: #fff;
      border-radius: 8px;
      padding: 24px;
      min-width: 340px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.18);
    }
    .modal-box h3 {
      margin: 0 0 16px;
      font-size: 1rem;
      color: #333;
    }
    .modal-box input[type="text"] {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.95rem;
      box-sizing: border-box;
    }
    .modal-actions {
      margin-top: 16px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .btn-criar {
      background: #4caf50;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 8px 20px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .btn-criar:hover { background: #43a047; }
    .btn-cancelar {
      background: #eee;
      color: #333;
      border: none;
      border-radius: 4px;
      padding: 8px 20px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .btn-cancelar:hover { background: #ddd; }
  </style>
</head>
<body>

<div id="gantt_here"></div>

<!-- Modal para nomear tarefa / subtarefa -->
<div id="modal-nova-tarefa" class="modal-overlay">
  <div class="modal-box">
    <h3 id="modal-titulo">Nomear a nova subtarefa</h3>
    <input type="text" id="modal-nome" placeholder="Nome da tarefa" />
    <div class="modal-actions">
      <button class="btn-cancelar" id="modal-cancelar">Cancelar</button>
      <button class="btn-criar" id="modal-criar">Criar</button>
    </div>
  </div>
</div>

<script>
  /* ================================================================
     Estado do modal
     ================================================================ */
  var modalState = { parentId: null, isMainTask: false };

  function abrirModal(parentId, isMainTask) {
    modalState.parentId = parentId;
    modalState.isMainTask = isMainTask;

    document.getElementById('modal-titulo').textContent =
      isMainTask ? 'Nomear a nova tarefa principal' : 'Nomear a nova subtarefa';

    var input = document.getElementById('modal-nome');
    input.value = '';
    document.getElementById('modal-nova-tarefa').classList.add('active');
    setTimeout(function() { input.focus(); }, 50);
  }

  function fecharModal() {
    document.getElementById('modal-nova-tarefa').classList.remove('active');
    modalState.parentId = null;
    modalState.isMainTask = false;
  }

  function criarTarefa() {
    var nome = document.getElementById('modal-nome').value.trim();
    if (!nome) return;

    var id = gantt.uid();
    var today = new Date();

    if (modalState.isMainTask) {
      gantt.addTask({ id: id, text: nome, start_date: today, duration: 5, progress: 0 });
    } else {
      gantt.addTask(
        { id: id, text: nome, start_date: today, duration: 3, progress: 0, parent: modalState.parentId }
      );
      gantt.open(modalState.parentId);
    }
    fecharModal();
  }

  /* ── Listeners do modal ── */
  document.getElementById('modal-criar').addEventListener('click', criarTarefa);
  document.getElementById('modal-cancelar').addEventListener('click', fecharModal);
  document.getElementById('modal-nome').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') criarTarefa();
    if (e.key === 'Escape') fecharModal();
  });
  document.getElementById('modal-nova-tarefa').addEventListener('click', function(e) {
    if (e.target === this) fecharModal();
  });

  /* ================================================================
     Interceptor em fase de captura
     Impede que o DHTMLX crie a tarefa antes do modal
     ================================================================ */
  document.addEventListener('click', function(e) {
    if (e.target.closest('.modal-overlay')) return;

    if (e.target.classList.contains('btn-add-sub')) {
      e.stopPropagation();
      e.preventDefault();
      abrirModal(e.target.getAttribute('data-task-id'), false);
      return;
    }

    if (e.target.classList.contains('header-add-btn')) {
      e.stopPropagation();
      e.preventDefault();
      abrirModal(null, true);
      return;
    }

    if (e.target.classList.contains('btn-expand')) {
      e.stopPropagation();
      e.preventDefault();
      var taskId = e.target.getAttribute('data-task-id');
      if (gantt.getTask(taskId).$open) {
        gantt.close(taskId);
      } else {
        gantt.open(taskId);
      }
      return;
    }

    var addBtn = e.target.closest('.gantt_add');
    if (addBtn) {
      e.stopPropagation();
      e.preventDefault();
    }
  }, true);

  /* ================================================================
     Configuração do Gantt
     ================================================================ */
  gantt.config.date_format = '%Y-%m-%d %H:%i';
  gantt.config.open_tree_initially = true;

  gantt.templates.grid_open = function() { return ''; };

  gantt.config.columns = [
    {
      name: 'text',
      label: '<span class="header-tarefas"><span>Tarefas</span><button class="header-add-btn" title="nova tarefa principal">+</button></span>',
      width: 300,
      tree: true,
      resize: true,
      template: function(task) {
        var isMain = !task.parent || task.parent === 0;
        if (isMain) {
          var icon = task.$open ? '\u25BC' : '\u25B6';
          return '<span class="task-cell">' +
            '<button class="btn-expand" data-task-id="' + task.id + '">' + icon + '</button>' +
            '<button class="btn-add-sub" data-task-id="' + task.id + '">+</button>' +
            '<span>' + task.text + '</span>' +
            '</span>';
        }
        return '<span>' + task.text + '</span>';
      }
    },
    { name: 'start_date', label: 'Início', align: 'center', width: 100 },
    { name: 'duration',   label: 'Duração', align: 'center', width: 70 }
  ];

  gantt.attachEvent('onTaskCreated', function() { return false; });

  gantt.init('gantt_here');

  gantt.parse({
    data: [
      { id: 1, text: 'Projeto Alpha', start_date: '2026-03-01 00:00', duration: 10, progress: 0.4, open: true },
      { id: 2, text: 'Pesquisa',       start_date: '2026-03-01 00:00', duration: 3,  parent: 1, progress: 1 },
      { id: 3, text: 'Desenvolvimento', start_date: '2026-03-04 00:00', duration: 5, parent: 1, progress: 0.3 },
      { id: 4, text: 'Projeto Beta',   start_date: '2026-03-02 00:00', duration: 8,  progress: 0.2, open: true },
      { id: 5, text: 'Design',         start_date: '2026-03-02 00:00', duration: 4,  parent: 4, progress: 0.5 }
    ]
  });
</script>
</body>
</html>
