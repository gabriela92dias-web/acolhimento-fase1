<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Adapta â€” Central do Agente</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; }

    .login-page { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
    .login-card { background: #1e293b; border-radius: 20px; padding: 40px; max-width: 360px; width: 100%; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
    .login-card h1 { font-size: 22px; margin-bottom: 4px; color: #fff; }
    .login-card .subtitle { color: #64748b; font-size: 13px; margin-bottom: 28px; }
    .login-card p.hint { color: #475569; font-size: 11px; margin-top: 8px; }
    .login-btn { display: block; width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; color: #fff; margin-bottom: 10px; transition: transform 0.15s, opacity 0.15s; }
    .login-btn:hover { transform: scale(1.02); opacity: 0.9; }
    .login-btn.clara { background: linear-gradient(135deg, #3b82f6, #6366f1); }
    .login-btn.thiago { background: linear-gradient(135deg, #8b5cf6, #a855f7); }

    .topbar { background: #1e293b; padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #334155; }
    .topbar-left { display: flex; align-items: center; gap: 10px; }
    .topbar h1 { font-size: 14px; font-weight: 700; color: #fff; }
    .topbar .badge { padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 600; }
    .badge-online { background: #22c55e; color: #fff; }
    .badge-pausa { background: #f59e0b; color: #fff; }
    .badge-offline { background: #475569; color: #94a3b8; }

    .main { max-width: 700px; margin: 0 auto; padding: 20px; }

    .turno-bar { background: #1e293b; border-radius: 14px; padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; gap: 12px; flex-wrap: wrap; }
    .turno-info { display: flex; align-items: center; gap: 12px; }
    .turno-timer { font-size: 28px; font-weight: 800; font-variant-numeric: tabular-nums; color: #fff; }
    .turno-timer.pausado { color: #f59e0b; }
    .turno-detail { font-size: 11px; color: #64748b; }
    .turno-actions { display: flex; gap: 6px; }
    .t-btn { padding: 8px 16px; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; color: #fff; }
    .t-btn-pausa { background: #f59e0b; }
    .t-btn-voltar { background: #3b82f6; }
    .t-btn-sair { background: #ef4444; }
    .t-btn-entrar { background: #22c55e; padding: 12px 24px; font-size: 14px; }
    .t-btn:hover { opacity: 0.85; }

    .section-title { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #475569; font-weight: 600; margin-bottom: 10px; }

    .links-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 24px; }
    .link-card { background: #1e293b; border-radius: 12px; padding: 16px; text-align: center; text-decoration: none; color: #e2e8f0; transition: transform 0.15s, background 0.15s; display: block; border: 1px solid #334155; }
    .link-card:hover { transform: translateY(-2px); background: #334155; }
    .link-icon { font-size: 28px; margin-bottom: 6px; }
    .link-name { font-size: 13px; font-weight: 600; }
    .link-desc { font-size: 10px; color: #64748b; margin-top: 2px; }

    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 24px; }
    .stat-card { background: #1e293b; border-radius: 10px; padding: 14px; text-align: center; border: 1px solid #334155; }
    .stat-card .sv { font-size: 24px; font-weight: 800; color: #fff; }
    .stat-card .sl { font-size: 10px; color: #64748b; text-transform: uppercase; margin-top: 2px; }

    .equipe { background: #1e293b; border-radius: 10px; padding: 14px; margin-bottom: 24px; border: 1px solid #334155; }
    .equipe-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; font-size: 13px; }

    .footer-link { text-align: center; margin-top: 8px; }
    .footer-link a { color: #475569; font-size: 11px; text-decoration: none; }
    .footer-link a:hover { color: #94a3b8; }
  </style>
</head>
<body>
  <div id="app"></div>
  <script>
    var API = window.location.origin;
    var app = document.getElementById('app');
    var agente = '';
    var timerRef = null;

    var params = {};
    window.location.search.slice(1).split('&').forEach(function(p) {
      var i = p.indexOf('=');
      if (i > 0) params[decodeURIComponent(p.slice(0, i))] = decodeURIComponent(p.slice(i + 1));
    });
    agente = params.agente || localStorage.getItem('acolhimento_agente') || '';

    function fmtHora(iso) { return iso ? new Date(iso).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : 'â€”'; }

    function calcTempoUtil(turno) {
      if (!turno || !turno.entrada) return 0;
      var fim = turno.saida ? new Date(turno.saida).getTime() : Date.now();
      var total = fim - new Date(turno.entrada).getTime();
      var pausas = 0;
      (turno.pausas || []).forEach(function(p) {
        var pFim = p.fim ? new Date(p.fim).getTime() : Date.now();
        pausas += pFim - new Date(p.inicio).getTime();
      });
      return Math.max(0, Math.floor((total - pausas) / 1000));
    }

    function fmtTimer(secs) {
      var h = Math.floor(secs / 3600), m = Math.floor((secs % 3600) / 60), s = secs % 60;
      return (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;
    }

    async function apiPost(url, body) {
      return (await fetch(API + url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })).json();
    }

    function loginPage() {
      app.innerHTML =
        '<div class="login-page"><div class="login-card">' +
          '<h1>Adapta</h1>' +
          '<div class="subtitle">Central do Agente</div>' +
          '<button class="login-btn clara" onclick="login(\'Clara\')">Entrar como Clara</button>' +
          '<button class="login-btn thiago" onclick="login(\'Thiago\')">Entrar como Thiago</button>' +
          '<p class="hint">Registre sua entrada antes de comeÃ§ar a atender</p>' +
        '</div></div>';
    }

    window.login = async function(nome) {
      agente = nome;
      localStorage.setItem('acolhimento_agente', nome);
      window.history.replaceState({}, '', '/painel?agente=' + encodeURIComponent(nome));
      await apiPost('/api/turnos/entrar', { agente: agente });
      carregar();
    };

    window.entrar = async function() { await apiPost('/api/turnos/entrar', { agente: agente }); carregar(); };
    window.sair = async function() { await apiPost('/api/turnos/sair', { agente: agente }); carregar(); };
    window.pausar = async function() { await apiPost('/api/turnos/pausar', { agente: agente }); carregar(); };

    function render(turnosData) {
      var todos = turnosData.turnos || [];
      var ativo = todos.find(function(t) { return !t.saida && t.agente === agente; });
      var emPausa = ativo && ativo.pausas.find(function(p) { return !p.fim; });

      var statusLabel, badgeClass;
      if (!ativo) { statusLabel = 'Offline'; badgeClass = 'badge-offline'; }
      else if (emPausa) { statusLabel = 'Em pausa'; badgeClass = 'badge-pausa'; }
      else { statusLabel = 'Online'; badgeClass = 'badge-online'; }

      var html =
        '<div class="topbar">' +
          '<div class="topbar-left"><h1>Adapta</h1></div>' +
          '<span class="badge ' + badgeClass + '">' + agente + ' Â· ' + statusLabel + '</span>' +
        '</div><div class="main">';

      html += '<div class="turno-bar">';
      if (ativo) {
        html +=
          '<div class="turno-info">' +
            '<div class="turno-timer ' + (emPausa ? 'pausado' : '') + '" id="pontoTimer">' + fmtTimer(calcTempoUtil(ativo)) + '</div>' +
            '<div class="turno-detail">Entrada ' + fmtHora(ativo.entrada) + (ativo.pausas.length > 0 ? ' Â· ' + ativo.pausas.length + ' pausa(s)' : '') + '</div>' +
          '</div>' +
          '<div class="turno-actions">' +
            (emPausa
              ? '<button class="t-btn t-btn-voltar" onclick="pausar()">Voltar</button>'
              : '<button class="t-btn t-btn-pausa" onclick="pausar()">Pausa</button>') +
            '<button class="t-btn t-btn-sair" onclick="sair()">Sair</button>' +
          '</div>';
      } else {
        html +=
          '<div class="turno-info"><div class="turno-detail">Nenhum turno ativo</div></div>' +
          '<div class="turno-actions"><button class="t-btn t-btn-entrar" onclick="entrar()">Iniciar turno</button></div>';
      }
      html += '</div>';

      html += '<div class="section-title">Ferramentas</div>';
      html += '<div class="links-grid">';
      html += '<a class="link-card" href="https://adapta.kommo.com" target="_blank"><div class="link-icon">ðŸ’¬</div><div class="link-name">Kommo</div><div class="link-desc">CRM Â· Leads Â· Chat</div></a>';
      html += '<a class="link-card" href="https://web.whatsapp.com" target="_blank"><div class="link-icon">ðŸ“±</div><div class="link-name">WhatsApp Web</div><div class="link-desc">Atendimento</div></a>';
      html += '<a class="link-card" href="https://adapta-cann.myshopify.com/admin" target="_blank"><div class="link-icon">ðŸ›’</div><div class="link-name">Shopify</div><div class="link-desc">Loja Â· Pedidos</div></a>';
      html += '<a class="link-card" href="' + API + '/funil" target="_blank"><div class="link-icon">ðŸ“Š</div><div class="link-name">Funil</div><div class="link-desc">Rastreamento</div></a>';
      html += '<a class="link-card" href="' + API + '/dashboard" target="_blank"><div class="link-icon">ðŸ“ˆ</div><div class="link-name">Dashboard</div><div class="link-desc">KPIs</div></a>';
      html += '</div>';

      var meusTurnos = todos.filter(function(t) { return t.agente === agente && t.saida; });
      var totalHoje = 0;
      meusTurnos.forEach(function(t) { totalHoje += calcTempoUtil(t); });
      if (ativo) totalHoje += calcTempoUtil(ativo);
      var hHoje = Math.floor(totalHoje / 3600), mHoje = Math.floor((totalHoje % 3600) / 60);

      html += '<div class="section-title">Seu dia</div>';
      html += '<div class="stats-grid">';
      html += '<div class="stat-card"><div class="sv">' + (hHoje > 0 ? hHoje + 'h' + mHoje : mHoje + 'min') + '</div><div class="sl">Tempo Ãºtil</div></div>';
      html += '<div class="stat-card"><div class="sv">' + (meusTurnos.length + (ativo ? 1 : 0)) + '</div><div class="sl">Turnos</div></div>';
      var totalPausas = 0;
      meusTurnos.forEach(function(t) { totalPausas += t.pausas.length; });
      if (ativo) totalPausas += ativo.pausas.length;
      html += '<div class="stat-card"><div class="sv">' + totalPausas + '</div><div class="sl">Pausas</div></div>';
      html += '</div>';

      var outroAgente = agente === 'Clara' ? 'Thiago' : 'Clara';
      var outroAtivo = todos.find(function(t) { return !t.saida && t.agente === outroAgente; });
      var outroPausa = outroAtivo && outroAtivo.pausas.find(function(p) { return !p.fim; });
      html += '<div class="section-title">Equipe</div>';
      html += '<div class="equipe"><div class="equipe-row"><span>' + outroAgente + '</span><span>' +
        (outroAtivo ? (outroPausa ? '<span class="badge badge-pausa">Em pausa</span>' : '<span class="badge badge-online">Online ' + fmtHora(outroAtivo.entrada) + '</span>') : '<span class="badge badge-offline">Offline</span>') +
        '</span></div></div>';

      html += '<div class="footer-link"><a href="/painel">Trocar agente</a></div>';
      html += '</div>';
      app.innerHTML = html;

      if (timerRef) clearInterval(timerRef);
      if (ativo) {
        timerRef = setInterval(function() {
          var el = document.getElementById('pontoTimer');
          if (el) el.textContent = fmtTimer(calcTempoUtil(ativo));
        }, 1000);
      }
    }

    async function carregar() {
      try {
        var res = await fetch(API + '/api/turnos?agente=');
        render(await res.json());
      } catch (e) { app.innerHTML = '<div style="text-align:center;padding:40px;color:#64748b">Falha na conexÃ£o.</div>'; }
    }

    if (agente && params.auto === '1') {
      apiPost('/api/turnos/entrar', { agente: agente }).then(function() {
        window.location.href = 'https://adapta.kommo.com';
      });
    } else if (agente) { carregar(); }
    else { loginPage(); }
  </script>
</body>
</html>
