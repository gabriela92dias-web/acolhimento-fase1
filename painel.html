<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel do Agente â€” Acolhimento</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, sans-serif; background: #f1f5f9; color: #1e293b; min-height: 100vh; }
    .topbar { background: #0f172a; color: #fff; padding: 14px 20px; display: flex; align-items: center; justify-content: space-between; }
    .topbar h1 { font-size: 15px; font-weight: 700; }
    .topbar .badge-agente { background: #2aa777; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
    .topbar .badge-offline { background: #64748b; }
    .topbar .badge-pausa { background: #f59e0b; }
    .container { max-width: 480px; margin: 0 auto; padding: 20px; }

    .ponto-card { background: #fff; border-radius: 14px; padding: 24px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; }
    .ponto-status { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; font-weight: 600; margin-bottom: 8px; }
    .ponto-timer { font-size: 36px; font-weight: 800; color: #0f172a; font-variant-numeric: tabular-nums; margin-bottom: 16px; }
    .ponto-timer.pausado { color: #f59e0b; }
    .ponto-hora { font-size: 12px; color: #94a3b8; margin-bottom: 16px; }

    .ponto-btns { display: flex; gap: 8px; }
    .ponto-btn { flex: 1; padding: 14px; border: none; border-radius: 10px; font-size: 14px; font-weight: 700; cursor: pointer; color: #fff; }
    .ponto-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-entrar { background: #22c55e; }
    .btn-entrar:hover:not(:disabled) { background: #16a34a; }
    .btn-pausa { background: #f59e0b; }
    .btn-pausa:hover:not(:disabled) { background: #d97706; }
    .btn-voltar { background: #3b82f6; }
    .btn-voltar:hover:not(:disabled) { background: #2563eb; }
    .btn-sair { background: #ef4444; }
    .btn-sair:hover:not(:disabled) { background: #dc2626; }

    .section { background: #fff; border-radius: 10px; padding: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); margin-bottom: 14px; }
    .section h3 { font-size: 12px; font-weight: 700; margin-bottom: 10px; text-transform: uppercase; color: #64748b; letter-spacing: 0.5px; }

    .turno-item { padding: 8px 0; border-bottom: 1px solid #f1f5f9; font-size: 12px; display: flex; justify-content: space-between; }
    .turno-item:last-child { border-bottom: none; }

    .escolha { text-align: center; padding: 60px 20px; }
    .escolha h2 { font-size: 20px; margin-bottom: 8px; }
    .escolha p { color: #94a3b8; font-size: 13px; margin-bottom: 24px; }
    .escolha-btn { display: block; width: 100%; max-width: 280px; margin: 10px auto; padding: 18px; border: none; border-radius: 12px; font-size: 18px; font-weight: 700; cursor: pointer; color: #fff; }
    .escolha-btn.clara { background: #3b82f6; }
    .escolha-btn.thiago { background: #8b5cf6; }
    .escolha-btn:hover { opacity: 0.9; }

    .empty { text-align: center; padding: 16px; color: #94a3b8; font-size: 12px; }
  </style>
</head>
<body>
  <div id="app"></div>
  <script>
    var API = window.location.origin;
    var app = document.getElementById('app');
    var agente = '';
    var timerRef = null;

    var params = {};
    window.location.search.slice(1).split('&').forEach(function(p) {
      var i = p.indexOf('=');
      if (i > 0) params[decodeURIComponent(p.slice(0, i))] = decodeURIComponent(p.slice(i + 1));
    });

    agente = params.agente || localStorage.getItem('acolhimento_agente') || '';

    function formatHora(iso) { return iso ? new Date(iso).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : 'â€”'; }
    function formatData(iso) { return iso ? new Date(iso).toLocaleString('pt-BR') : 'â€”'; }

    function calcTempo(inicio, fim) {
      var end = fim ? new Date(fim).getTime() : Date.now();
      var diff = Math.max(0, Math.floor((end - new Date(inicio).getTime()) / 1000));
      var h = Math.floor(diff / 3600);
      var m = Math.floor((diff % 3600) / 60);
      var s = diff % 60;
      return (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;
    }

    function calcTempoUtil(turno) {
      if (!turno || !turno.entrada) return 0;
      var fim = turno.saida ? new Date(turno.saida).getTime() : Date.now();
      var total = fim - new Date(turno.entrada).getTime();
      var pausas = 0;
      (turno.pausas || []).forEach(function(p) {
        var pFim = p.fim ? new Date(p.fim).getTime() : Date.now();
        pausas += pFim - new Date(p.inicio).getTime();
      });
      return Math.max(0, Math.floor((total - pausas) / 1000));
    }

    function escolher() {
      app.innerHTML =
        '<div class="topbar"><h1>Acolhimento â€” Controle de Turno</h1></div>' +
        '<div class="escolha">' +
          '<h2>Identifique-se para comeÃ§ar</h2>' +
          '<p>VocÃª precisa registrar sua entrada antes de acessar o Kommo</p>' +
          '<button class="escolha-btn clara" onclick="iniciar(\'Clara\')">Clara</button>' +
          '<button class="escolha-btn thiago" onclick="iniciar(\'Thiago\')">Thiago</button>' +
        '</div>';
    }

    window.iniciar = async function(nome) {
      agente = nome;
      localStorage.setItem('acolhimento_agente', nome);
      window.history.replaceState({}, '', '/painel?agente=' + encodeURIComponent(nome));
      await apiPost('/api/turnos/entrar', { agente: agente });
      window.open('https://adapta.kommo.com', '_blank');
      carregar();
    };

    async function apiPost(url, body) {
      var res = await fetch(API + url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      return res.json();
    }

    window.entrar = async function() {
      await apiPost('/api/turnos/entrar', { agente: agente });
      window.open('https://adapta.kommo.com', '_blank');
      carregar();
    };
    window.sair = async function() { await apiPost('/api/turnos/sair', { agente: agente }); carregar(); };
    window.pausar = async function() { await apiPost('/api/turnos/pausar', { agente: agente }); carregar(); };

    function render(turnosData) {
      var turnosList = turnosData.turnos || [];
      var ativo = turnosList.find(function(t) { return !t.saida && t.agente === agente; });
      var emPausa = ativo && ativo.pausas.find(function(p) { return !p.fim; });

      var statusLabel, statusClass, timerClass;
      if (!ativo) { statusLabel = 'OFFLINE'; statusClass = 'badge-offline'; }
      else if (emPausa) { statusLabel = 'EM PAUSA'; statusClass = 'badge-pausa'; timerClass = 'pausado'; }
      else { statusLabel = 'ONLINE'; statusClass = ''; }

      var html =
        '<div class="topbar">' +
          '<h1>Painel do Agente</h1>' +
          '<span class="badge-agente ' + statusClass + '">' + agente + ' Â· ' + statusLabel + '</span>' +
        '</div>' +
        '<div class="container">';

      html += '<div class="ponto-card">';
      html += '<div class="ponto-status">' + statusLabel + '</div>';

      if (ativo) {
        var secsUtil = calcTempoUtil(ativo);
        html += '<div class="ponto-timer ' + (timerClass || '') + '" id="pontoTimer">' + calcTempo(ativo.entrada) + '</div>';
        html += '<div class="ponto-hora">Entrada: ' + formatHora(ativo.entrada);
        if (ativo.pausas.length > 0) html += ' Â· ' + ativo.pausas.length + ' pausa(s)';
        html += '</div>';

        html += '<div class="ponto-btns">';
        if (emPausa) {
          html += '<button class="ponto-btn btn-voltar" onclick="pausar()">Voltar</button>';
        } else {
          html += '<button class="ponto-btn btn-pausa" onclick="pausar()">Pausa</button>';
        }
        html += '<button class="ponto-btn btn-sair" onclick="sair()">Encerrar turno</button>';
        html += '</div>';
      } else {
        html += '<div class="ponto-timer">--:--:--</div>';
        html += '<div class="ponto-hora">Nenhum turno ativo</div>';
        html += '<div class="ponto-btns">';
        html += '<button class="ponto-btn btn-entrar" onclick="entrar()">Iniciar turno</button>';
        html += '</div>';
      }
      html += '</div>';

      var historico = turnosList.filter(function(t) { return t.agente === agente && t.saida; }).slice(0, 5);
      if (historico.length > 0) {
        html += '<div class="section"><h3>Ãšltimos turnos</h3>';
        historico.forEach(function(t) {
          var secsUtil = calcTempoUtil(t);
          var h = Math.floor(secsUtil / 3600);
          var m = Math.floor((secsUtil % 3600) / 60);
          var tempo = h > 0 ? h + 'h ' + m + 'min' : m + 'min';
          html += '<div class="turno-item"><span>' + formatData(t.entrada) + '</span><span>' + tempo + ' Ãºteis Â· ' + t.pausas.length + ' pausa(s)</span></div>';
        });
        html += '</div>';
      }

      var outroAgente = agente === 'Clara' ? 'Thiago' : 'Clara';
      var outroOnline = turnosList.find(function(t) { return !t.saida && t.agente === outroAgente; });
      var outroEmPausa = outroOnline && outroOnline.pausas.find(function(p) { return !p.fim; });
      html += '<div class="section"><h3>Equipe</h3>';
      html += '<div class="turno-item"><span>' + outroAgente + '</span><span>' +
        (outroOnline ? (outroEmPausa ? 'ðŸŸ¡ Em pausa' : 'ðŸŸ¢ Online desde ' + formatHora(outroOnline.entrada)) : 'âš« Offline') +
        '</span></div>';
      html += '</div>';

      html += '<div style="text-align:center;margin-top:12px"><a href="/painel" style="color:#94a3b8;font-size:11px;text-decoration:none;">Trocar agente</a></div>';
      html += '</div>';
      app.innerHTML = html;

      if (timerRef) clearInterval(timerRef);
      if (ativo) {
        timerRef = setInterval(function() {
          var el = document.getElementById('pontoTimer');
          if (el) {
            var secs = calcTempoUtil(ativo);
            var h = Math.floor(secs / 3600), m = Math.floor((secs % 3600) / 60), s = secs % 60;
            el.textContent = (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;
          }
        }, 1000);
      }
    }

    async function carregar() {
      try {
        var res = await fetch(API + '/api/turnos?agente=');
        var data = await res.json();
        render(data);
      } catch (e) { app.innerHTML = '<div class="empty">Falha na conexÃ£o.</div>'; }
    }

    if (agente) { carregar(); } else { escolher(); }
  </script>
</body>
</html>
