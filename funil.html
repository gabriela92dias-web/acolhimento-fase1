<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rastreamento do Funil — Acolhimento</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, sans-serif; background: #f1f5f9; color: #1e293b; min-height: 100vh; }
    .topbar { background: #fff; border-bottom: 1px solid #e2e8f0; padding: 14px 24px; display: flex; align-items: center; justify-content: space-between; }
    .topbar h1 { font-size: 16px; font-weight: 700; }
    .topbar-actions { display: flex; gap: 8px; }
    .btn-link { background: none; border: 1px solid #cbd5e1; border-radius: 6px; padding: 6px 12px; font-size: 12px; cursor: pointer; color: #475569; text-decoration: none; }
    .btn-link:hover { background: #f8fafc; }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 14px; margin-bottom: 24px; }
    .kpi-card { background: #fff; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
    .kpi-card .k-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: #94a3b8; font-weight: 600; margin-bottom: 4px; }
    .kpi-card .k-value { font-size: 28px; font-weight: 800; color: #0f172a; line-height: 1; }
    .section { background: #fff; border-radius: 12px; padding: 18px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); margin-bottom: 20px; }
    .section h2 { font-size: 14px; font-weight: 700; margin-bottom: 14px; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th { text-align: left; padding: 8px 10px; border-bottom: 2px solid #e2e8f0; color: #64748b; font-weight: 600; font-size: 11px; text-transform: uppercase; }
    td { padding: 8px 10px; border-bottom: 1px solid #f1f5f9; }
    tr:hover td { background: #f8fafc; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; text-transform: uppercase; }
    .badge-add { background: #dcfce7; color: #16a34a; }
    .badge-update { background: #dbeafe; color: #2563eb; }
    .badge-status { background: #fef3c7; color: #d97706; }
    .badge-delete { background: #fee2e2; color: #dc2626; }
    .tempo { font-variant-numeric: tabular-nums; font-weight: 600; }
    .etapa-bar { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .etapa-bar .bar-label { width: 100px; font-size: 12px; color: #64748b; text-align: right; flex-shrink: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .etapa-bar .bar-track { flex: 1; background: #f1f5f9; border-radius: 4px; height: 24px; overflow: hidden; position: relative; }
    .etapa-bar .bar-fill { height: 100%; border-radius: 4px; background: #3b82f6; display: flex; align-items: center; padding: 0 8px; min-width: 30px; }
    .etapa-bar .bar-fill span { font-size: 10px; color: #fff; font-weight: 600; }
    .loading { text-align: center; padding: 40px; color: #94a3b8; }
    .empty { text-align: center; padding: 24px; color: #94a3b8; font-size: 13px; }
    .webhook-url { background: #0f172a; color: #22c55e; padding: 12px 16px; border-radius: 8px; font-family: monospace; font-size: 13px; word-break: break-all; margin-bottom: 8px; }
    .webhook-hint { font-size: 11px; color: #94a3b8; }
  </style>
</head>
<body>
  <div class="topbar">
    <h1>Rastreamento do Funil</h1>
    <div class="topbar-actions">
      <a class="btn-link" href="/dashboard">Dashboard</a>
      <a class="btn-link" href="/relatorio">Por Agente</a>
      <button class="btn-link" onclick="carregar()">Atualizar</button>
    </div>
  </div>
  <div class="container">
    <div class="section">
      <h2>Configuração do Webhook</h2>
      <p style="font-size:12px;color:#64748b;margin-bottom:8px;">Cole esta URL no Kommo em <strong>Configurações → Integrações → Web Hooks</strong>:</p>
      <div class="webhook-url" id="webhookUrl"></div>
      <p class="webhook-hint">Marque os eventos: "Mudança na etapa do lead", "Lead editado", "Lead adicionado"</p>
    </div>
    <div id="root"><div class="loading">Carregando dados…</div></div>
  </div>
  <script>
    var API = window.location.origin;
    document.getElementById('webhookUrl').textContent = API + '/api/webhook/kommo';

    function formatTempo(seg) {
      if (!seg || seg <= 0) return '—';
      var d = Math.floor(seg / 86400);
      var h = Math.floor((seg % 86400) / 3600);
      var m = Math.floor((seg % 3600) / 60);
      if (d > 0) return d + 'd ' + h + 'h';
      if (h > 0) return h + 'h ' + m + 'min';
      if (m > 0) return m + 'min';
      return seg + 's';
    }

    function formatData(iso) {
      if (!iso) return '—';
      return new Date(iso).toLocaleString('pt-BR');
    }

    function tipoBadge(tipo) {
      var map = { add: 'badge-add', update: 'badge-update', status: 'badge-status', delete: 'badge-delete' };
      var labels = { add: 'Criado', update: 'Atualizado', status: 'Mudou etapa', delete: 'Removido' };
      return '<span class="badge ' + (map[tipo] || 'badge-update') + '">' + (labels[tipo] || tipo) + '</span>';
    }

    async function carregar() {
      try {
        var [funilRes, logsRes] = await Promise.all([
          fetch(API + '/api/relatorio/funil'),
          fetch(API + '/api/logs?tipo=')
        ]);
        var funil = await funilRes.json();
        var logsData = await logsRes.json();
        render(funil, logsData);
      } catch (e) {
        document.getElementById('root').innerHTML = '<div class="loading">Falha ao carregar.</div>';
      }
    }

    function render(funil, logsData) {
      var root = document.getElementById('root');
      var html = '';

      html +=
        '<div class="kpi-grid">' +
          '<div class="kpi-card"><div class="k-label">Total de eventos</div><div class="k-value">' + funil.totalLogs + '</div></div>' +
          '<div class="kpi-card"><div class="k-label">Leads rastreados</div><div class="k-value">' + funil.totalLeads + '</div></div>' +
          '<div class="kpi-card"><div class="k-label">Etapas ativas</div><div class="k-value">' + funil.etapas.length + '</div></div>' +
          '<div class="kpi-card"><div class="k-label">Agentes ativos</div><div class="k-value">' + funil.agentes.length + '</div></div>' +
        '</div>';

      if (funil.etapas.length > 0) {
        var maxEntradas = Math.max.apply(null, funil.etapas.map(function(e) { return e.entradas; }));
        html += '<div class="section"><h2>Movimentações por Etapa</h2>';
        funil.etapas.forEach(function(e) {
          var pct = Math.round(e.entradas / maxEntradas * 100);
          html +=
            '<div class="etapa-bar">' +
              '<span class="bar-label" title="ID: ' + e.statusId + '">Etapa ' + e.statusId + '</span>' +
              '<div class="bar-track"><div class="bar-fill" style="width:' + pct + '%"><span>' + e.entradas + ' mov · ' + e.leadsUnicos + ' leads · ' + formatTempo(e.tempoMedioSegundos) + '</span></div></div>' +
            '</div>';
        });
        html += '</div>';
      }

      if (funil.agentes.length > 0) {
        html += '<div class="section"><h2>Atividade por Agente</h2><table><thead><tr><th>#</th><th>ID Agente</th><th>Movimentações</th><th>Leads</th></tr></thead><tbody>';
        funil.agentes.forEach(function(a, i) {
          html += '<tr><td>' + (i+1) + '</td><td>' + a.agenteId + '</td><td>' + a.movimentacoes + '</td><td>' + a.leadsUnicos + '</td></tr>';
        });
        html += '</tbody></table></div>';
      }

      var logsList = logsData.logs || [];
      if (logsList.length > 0) {
        html += '<div class="section"><h2>Últimos Eventos (' + logsData.total + ' total)</h2><table><thead><tr><th>Quando</th><th>Tipo</th><th>Lead</th><th>Etapa</th><th>Agente</th></tr></thead><tbody>';
        logsList.slice(0, 50).forEach(function(l) {
          html +=
            '<tr>' +
              '<td>' + formatData(l.timestamp) + '</td>' +
              '<td>' + tipoBadge(l.tipo) + '</td>' +
              '<td>' + (l.leadNome || '#' + l.leadId) + '</td>' +
              '<td>' + (l.statusAnteriorId && l.statusId ? l.statusAnteriorId + ' → ' + l.statusId : l.statusId || '—') + '</td>' +
              '<td>' + (l.responsavelId || l.modificadoPorId || '—') + '</td>' +
            '</tr>';
        });
        html += '</tbody></table></div>';
      } else {
        html += '<div class="section"><div class="empty">Nenhum evento registrado ainda.<br>Configure o webhook acima no Kommo para começar a rastrear.</div></div>';
      }

      root.innerHTML = html;
    }

    carregar();
  </script>
</body>
</html>
